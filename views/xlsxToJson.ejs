<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />
    <title>Excel to JSON Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .input-container {
            margin-bottom: 20px;
        }

        .input-container input[type="file"] {
            display: none;
        }

        .input-container label {
            display: block;
            padding: 10px 15px;
            background-color: #007bff;
            color: #fff;
            text-align: center;
            cursor: pointer;
            border-radius: 5px;
        }

        .input-container label:hover {
            background-color: #0056b3;
        }

        .btn {
            padding: 10px 15px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="input-container">
            <input type="file" id="excel_file" 
                   accept=".xlsx, .xls" />
            <label for="excel_file">
              Select Excel File
              </label>
        </div>

        <button class="btn" id="angus_btn">
          ANGUS
          </button>

        <button class="btn" id="limousine_btn">
          LIMOUSINE
        </button>

        <button class="btn" id="convert_btn">
          Convert to JSON
          </button>

        <div class="input-container">
            <textarea id="json_data" rows="10" 
                      cols="50" readonly>
              </textarea>
        </div>

        <button class="btn" id="download_btn">
          Download JSON File
          </button>

        <button class="btn" id="upload_btn" style="background-color: #28a745;">
          Upload to MongoDB
          </button>

        <div id="upload_status" style="margin-top: 20px; padding: 10px; display: none; border-radius: 5px;">
        </div>
    </div>

    <script src=
"https://unpkg.com/read-excel-file@5.8.8/bundle/read-excel-file.min.js">
      </script>

    <script>

// Global variable to track selected race
let selectedRace = 'Angus';

// Angus button handler
document.getElementById("angus_btn").addEventListener("click", function () {
    selectedRace = 'Angus';
    this.style.backgroundColor = '#28a745';
    document.getElementById("limousine_btn").style.backgroundColor = '#007bff';
});

// Limousine button handler
document.getElementById("limousine_btn").addEventListener("click", function () {
    selectedRace = 'Limousin';
    this.style.backgroundColor = '#28a745';
    document.getElementById("angus_btn").style.backgroundColor = '#007bff';
});

// Set default Angus button to green
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById("angus_btn").style.backgroundColor = '#28a745';
});

document
  .getElementById("convert_btn")
  .addEventListener("click", function () {
    const input = document.getElementById("excel_file");

    readXlsxFile(input.files[0]).then(function (rows) {

      const HEADER_MAP = {
        "Marca de Explora√ß√£o N¬∫ Brinco": "tag",
        "VX33C Chk Digit": "checkDigit",
        "VX64I Chk Digit": "checkDigit",
        "Data Nas.": "birthDate",
        //"Sexo": "sexo",
        //"Data Ent. na Exp.": "data_entrada_exploracao",
        "Ra√ßa": "race",
        "Data √ölt. Parto": "lastTimeCalved",
      };

      // üß† Tipos esperados por campo
      const FIELD_TYPES = {
        tag: "string",
        checkDigit: "number",
        race: "string",
        birthDate: "date",
        lastTimeCalved: "date",
        comments: "string"
      };

      // üîß Fun√ß√£o de cast segura
      function castValue(value, type) {
        if (value == null || value === '') return null;

        switch (type) {
          case "number": {
            const n = Number(
              String(value)
                .replace(',', '.')
                .replace(/\s/g, '')
            );
            return Number.isNaN(n) ? null : n;
          }

          case "date":
            return value instanceof Date
              ? value.toISOString().split('T')[0]
              : null;

          default:
            return String(value).trim();
        }
      }

      const jsonData = [];
      let i = 0;

      while (i < rows.length) {
        const cell = rows[i][0];

        if (cell && String(cell).startsWith("N¬∫ Cont.")) {
          const headerRow = rows[i + 1];
          let dataIndex = i + 2;

          if (!headerRow) break;

          const headers = headerRow
            .slice(1)
            .map((h, colIndex) => {
              const original = String(h || '');

              const normalized = original
                .replace(/\r?\n/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();

              if (HEADER_MAP[normalized]) {
                return {
                  key: HEADER_MAP[normalized],
                  colIndex: colIndex + 1
                };
              }
              return null;
            })
            .filter(Boolean);

          // Dados
          while (dataIndex < rows.length) {
            const row = rows[dataIndex];

            // Fim normal da tabela
            if (!row || !row[1]) break;

            // Extract original race value first
            let originalRace = "-";
            const raceHeader = headers.find(h => h.key === 'race');
            if (raceHeader && row[raceHeader.colIndex]) {
              originalRace = castValue(row[raceHeader.colIndex], FIELD_TYPES['race']);
            }

            const obj = {
              comments: originalRace,
            };

            headers.forEach(h => {
                if(h.key == 'race'){
                    obj[h.key] = castValue(
                    selectedRace,
                    FIELD_TYPES[h.key]
                    );
                } else {
                    obj[h.key] = castValue(
                    row[h.colIndex],
                    FIELD_TYPES[h.key]
                    );
                }
              
            });
            

            // ‚ùó Ignorar footer "Total de Aleitantes"
            if (
              obj.tag &&
              String(obj.tag).trim() === "Total de Aleitantes"
            ) {
              dataIndex++;
              continue;
            }

            jsonData.push(obj);
            dataIndex++;
          }

          i = dataIndex;
          continue;
        }

        i++;
      }

      document.getElementById("json_data").value = JSON.stringify(
        jsonData,
        null,
        2
      );
    });
  });

        document
            .getElementById("download_btn")
            .addEventListener("click", function () {
                const jsonData = document.getElementById("json_data").value;
                downloadObjectAsJson(jsonData, "excel_to_json");
            });

        document
            .getElementById("upload_btn")
            .addEventListener("click", async function () {
                const jsonDataStr = document.getElementById("json_data").value;
                
                if (!jsonDataStr || jsonDataStr.trim() === '') {
                    showStatus('Por favor, converta um arquivo Excel primeiro!', 'warning');
                    return;
                }

                try {
                    const cows = JSON.parse(jsonDataStr);
                    
                    if (!Array.isArray(cows)) {
                        showStatus('Erro: Dados inv√°lidos. Esperado um array de vacas.', 'danger');
                        return;
                    }

                    // Disable button and show loading
                    const uploadBtn = document.getElementById("upload_btn");
                    uploadBtn.disabled = true;
                    uploadBtn.textContent = "Enviando...";

                    const response = await fetch('/bulkAddCows', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({ cows: cows })
                    });

                    // Get response text first to handle potential non-JSON responses
                    const responseText = await response.text();
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseErr) {
                        console.error('Response text:', responseText);
                        showStatus(`Erro no servidor: ${response.status} ${response.statusText}. Verifique a consola do navegador.`, 'danger');
                        return;
                    }

                    if (response.ok) {
                        showStatus(`‚úì ${result.message}`, 'success');
                    } else {
                        showStatus(`‚úó ${result.message}`, result.type || 'danger');
                    }

                } catch (err) {
                    showStatus(`Erro: ${err.message}`, 'danger');
                    console.error('Upload error:', err);
                } finally {
                    const uploadBtn = document.getElementById("upload_btn");
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = "Upload to MongoDB";
                }
            });

        function showStatus(message, type) {
            const statusDiv = document.getElementById("upload_status");
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Set background color based on type
            const colors = {
                'success': '#d4edda',
                'danger': '#f8d7da',
                'warning': '#fff3cd'
            };
            const textColors = {
                'success': '#155724',
                'danger': '#721c24',
                'warning': '#856404'
            };
            
            statusDiv.style.backgroundColor = colors[type] || colors['danger'];
            statusDiv.style.color = textColors[type] || textColors['danger'];
            statusDiv.style.border = `1px solid ${textColors[type] || textColors['danger']}`;
        }

        function downloadObjectAsJson(jsonData, filename) {
            const dataStr =
                "data:text/json;charset=utf-8," + 
                  encodeURIComponent(jsonData);
            const downloadAnchorNode = document.createElement("a");
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", filename + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>

</html>
